



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-\.]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Scenario 2 Defense - KubeCon NA 2019 Tutorial Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="red" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#persistence-scenario-2-defense" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="KubeCon NA 2019 Tutorial Guide" class="md-header-nav__button md-logo">
          
            <i class="md-icon">cloud</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              KubeCon NA 2019 Tutorial Guide
            </span>
            <span class="md-header-nav__topic">
              
                Scenario 2 Defense
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/securekubernetes/securekubernetes/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    securekubernetes/securekubernetes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="KubeCon NA 2019 Tutorial Guide" class="md-nav__button md-logo">
      
        <i class="md-icon">cloud</i>
      
    </a>
    KubeCon NA 2019 Tutorial Guide
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/securekubernetes/securekubernetes/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    securekubernetes/securekubernetes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Getting Connected" class="md-nav__link">
      Getting Connected
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../scenario_1_attack/" title="Scenario 1 Attack" class="md-nav__link">
      Scenario 1 Attack
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../scenario_1_defense/" title="Scenario 1 Defense" class="md-nav__link">
      Scenario 1 Defense
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../scenario_2_attack/" title="Scenario 2 Attack" class="md-nav__link">
      Scenario 2 Attack
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Scenario 2 Defense
      </label>
    
    <a href="./" title="Scenario 2 Defense" class="md-nav__link md-nav__link--active">
      Scenario 2 Defense
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    Backstory
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-blue" class="md-nav__link">
    Name: Blue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    Motivations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-the-issue" class="md-nav__link">
    Identifying the Issue
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#backstory" class="md-nav__link">
    Backstory
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#name-blue" class="md-nav__link">
    Name: Blue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#motivations" class="md-nav__link">
    Motivations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defense" class="md-nav__link">
    Defense
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identifying-the-issue" class="md-nav__link">
    Identifying the Issue
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/securekubernetes/securekubernetes/edit/master/docs/scenario_2_defense.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="persistence-scenario-2-defense">Persistence: Scenario 2 Defense<a class="headerlink" href="#persistence-scenario-2-defense" title="Permanent link">&para;</a></h1>
<h2 id="backstory">Backstory<a class="headerlink" href="#backstory" title="Permanent link">&para;</a></h2>
<h3 id="name-blue">Name: <strong>Blue</strong><a class="headerlink" href="#name-blue" title="Permanent link">&para;</a></h3>
<ul>
<li>Still overworked</li>
<li>Still can only do the bare minimum</li>
<li>Uses the defaults when configuring systems</li>
<li>Usually gets blamed for stability or security issues</li>
</ul>
<h3 id="motivations">Motivations<a class="headerlink" href="#motivations" title="Permanent link">&para;</a></h3>
<ul>
<li>A week after the first incident, <strong>Blue</strong> gets paged at 3am because “website is slow again”.</li>
<li><strong>Blue</strong>, puzzled, takes another look.</li>
<li><strong>Blue</strong> decides to dust-off the résumé “just in case”.</li>
</ul>
<h2 id="defense">Defense<a class="headerlink" href="#defense" title="Permanent link">&para;</a></h2>
<p><strong>Blue</strong> is paged again with the same message as last time. What is going on? Could this be the same problem again?</p>
<h3 id="identifying-the-issue">Identifying the Issue<a class="headerlink" href="#identifying-the-issue" title="Permanent link">&para;</a></h3>
<p>Let's run some basic checks again to see if we can find random workloads:</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl get pods --all-namespaces</span>
</pre></div>

<p>There does not appear to be any unusual workloads running on our cluster.</p>
<p>Just to be sure, let's check our cluster's resource consumption:</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl top node</span>
</pre></div>

<p>and</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl top pod --all-namespaces</span>
</pre></div>

<p>So far, everything looks normal. What gives?</p>
<p>Hold on. We installed <code>falco</code> last time and it is throwing us alerts in StackDriver.</p>
<p>In a new <a href="https://console.cloud.google.com/logs/viewer" target="_blank">StackDriver window</a>, let's run the query:</p>
<div class="codehilite"><pre><span></span><span class="go">resource.type=&quot;container&quot;</span>
<span class="go">resource.labels.container_name:&quot;falco&quot;</span>
<span class="go">jsonPayload.rule=&quot;Launch Privileged Container&quot; OR jsonPayload.rule=&quot;Terminal shell in container&quot;</span>
</pre></div>

<p>We're looking for <code>container</code> logs from <code>falco</code> where triggered rules are privileged containers or interactive shells.</p>
<p>Huh. This is odd. A privileged <code>alpine</code> container, but no other information to go off of? What can kubernetes cluster logs tell us about this <code>alpine</code> container?</p>
<p>In a new <a href="https://console.cloud.google.com/logs/viewer" target="_blank">StackDriver window</a>, let's run this query:</p>
<div class="codehilite"><pre><span></span><span class="go">resource.type=k8s_cluster</span>
<span class="go">protoPayload.request.spec.containers.image=&quot;alpine&quot;</span>
</pre></div>

<p>So, we see a few things:</p>
<ol>
<li>A create event that was authorized with the <code>system:serviceaccount:dev:default</code> serviceaccount in the <code>dev</code> namespace.</li>
<li>A pod named <code>r00t</code> got created</li>
<li>The pod command is <code>nsenter --mount=/proc/1/ns/mnt -- /bin/bash</code></li>
<li>The <code>securityContext</code> is <code>privileged: true</code></li>
<li>The <code>hostPID</code> is set to <code>true</code></li>
</ol>
<p>This is not looking good. Can we see what this container did?</p>
<p>In a new <a href="https://console.cloud.google.com/logs/viewer" target="_blank">StackDriver window</a>, let's search for this <code>r00t</code> container logs:</p>
<div class="codehilite"><pre><span></span><span class="go">resource.type=&quot;container&quot;</span>
<span class="go">resource.labels.pod_id:r00t</span>
</pre></div>

<p>Wow. We can see someone was running commands from this container.</p>
<p>But wait, they can run docker commands? How can they talk to the docker on the host from the container? OH NO! They must have broken out of the container and by this point they're on the host!</p>
<p>That <code>bitcoinero</code> container again must be what's causing slowness. But, they're trying to do something else.</p>
<p>They tried to create a pod, but failed. So, they created a Service and an Endpoint. They must be trying to open a backdoor of some sort to get back in later.</p>
<p>In cloud shell, let's check if those exist:</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl -n kube-system get svc,ep</span>
</pre></div>

<p>That's one sneaky hacker, for sure. But, jokes on them, We're not using service mesh.</p>
<p>Let's delete that service (the endpoint will be deleted too):</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl -n kube-system delete svc/istio-mgmt</span>
</pre></div>

<p>But, I want to know how did they get in in the first place?!?!?! The <code>create</code> event authorized because of the <code>dev:default</code> serviceaccount. So, what is in <code>dev</code> namespace that led to someone taking over the entire host?</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl -n dev get pods</span>
</pre></div>

<p>There is an <code>app</code>, a <code>db</code>, and a <code>dashboard</code>. Wait a second! Could it be an exposed dashboard?</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl -n dev logs $(kubectl -n dev get pods -o name | grep dashboard) -c dashboard</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="go">kubectl -n dev logs $(kubectl -n dev get pods -o name | grep dashboard) -c authproxy</span>
</pre></div>

<p>It is an exposed dashboard. That's how they got in. There is <code>GET /webshell</code> in authproxy logs with the source IP.</p>
<p>I might want to disable automatically mounting the serviceaccount token by setting <code>automountServiceAccountToken: false</code> in the pod spec. But, how can we mitigate this further?</p>
<p>The attacker ran a privileged container, which they shouldn't have been able to. So, we should block that. I remember a talk at KubeCon this week about Open-Policy-Agent/Gatekeeper that gets deployed as an admission controller.</p>
<p>That should work because an admission controller is a piece of code that intercepts requests to the Kubernetes API server after the request is authenticated and authorized.</p>
<p><img alt="opa admission gatekeeper" src="../img/opa.png" /></p>
<p>So, we can set a policy that will deny privileged containers and allow only the images we expect to have on our cluster:</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl apply -f https://raw.githubusercontent.com/securekubernetes/securekubernetes/master/manifests/security2.yaml</span>
<span class="go">sleep 10</span>
<span class="go">kubectl apply -f https://raw.githubusercontent.com/securekubernetes/securekubernetes/master/manifests/security2-policies.yaml</span>
</pre></div>

<p>Let's see if this actually works (sometimes it takes a few seconds for policies to take effect):</p>
<div class="codehilite"><pre><span></span><span class="go">kubectl -n dev run alpine --image=alpine --restart=Never</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="go">cat &lt;&lt;EOF &gt;priv-pod.yaml</span>
<span class="go">apiVersion: v1</span>
<span class="go">kind: Pod</span>
<span class="go">metadata:</span>
<span class="go">  name: privileged-pod</span>
<span class="go">spec:</span>
<span class="go">  containers:</span>
<span class="go">  - name: ubuntu</span>
<span class="go">    image: ubuntu</span>
<span class="go">    stdin: true</span>
<span class="go">    securityContext:</span>
<span class="go">      privileged: true</span>
<span class="go">EOF</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="go">kubectl -n dev apply -f priv-pod.yaml</span>
</pre></div>

<p>It works!</p>
<p>I should tell the boss about this.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../scenario_2_attack/" title="Scenario 2 Attack" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Scenario 2 Attack
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/tabbysable/kubeconctf19" class="md-footer-social__link fa fa-github-alt"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>